dist: xenial

git:
  depth: false

language: python

python:
  - 3.6

# We add python path and all R dependencies to enable testing jupyter notebooks
install:
  - travis_retry pip install -r requirements.txt
  - travis_retry pip install -r requirements-test.txt
  - travis_retry export PYTHONPATH=$PWD
  - travis_retry sudo add-apt-repository 'deb https://cloud.r-project.org/bin/linux/ubuntu xenial-cran40/'
  - travis_retry sudo apt-get update
  - travis_retry sudo apt-get -y --allow-unauthenticated install r-base r-base-dev
  - travis_retry sudo apt-get install wget
  - travis_retry sudo wget https://cran.r-project.org/src/contrib/Archive/BH/BH_1.72.0-3.tar.gz
  - travis_retry Rscript -e 'dir.create(path=Sys.getenv("R_LIBS_USER"), showWarnings=FALSE, recursive=TRUE)'
  - travis_retry Rscript -e 'install.packages("BH_1.72.0-3.tar.gz", lib=Sys.getenv("R_LIBS_USER"), repos=NULL, type="source")'   # need to override the default BH installation for cytolib/FlowSOM
  - travis_retry Rscript -e 'install.packages("data.table", lib=Sys.getenv("R_LIBS_USER"), repos="http://cran.us.r-project.org")'
  - travis_retry Rscript -e 'install.packages("BiocManager", lib=Sys.getenv("R_LIBS_USER"), repos="http://cran.us.r-project.org")'
  - travis_retry Rscript -e 'BiocManager::install("cytolib", lib=Sys.getenv("R_LIBS_USER"))'
  - travis_retry Rscript -e 'BiocManager::install("FlowSOM", lib=Sys.getenv("R_LIBS_USER"))'
  - travis_retry Rscript -e 'BiocManager::install("rhdf5", lib=Sys.getenv("R_LIBS_USER"))'

env:
  - MPLBACKEND=Agg

cache: pip

# command to run tests
script:
  - python -m pytest --cov=ark --pycodestyle ark

jobs:
  include:
    - stage: deploy
      deploy:
        provider: pypi
        user: $PYPI_USERNAME
        password: $PYPI_PASSWORD
        on:
          tags: true

after_success:
  - coveralls
